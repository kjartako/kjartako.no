---
title: Stan-code for Markov-switching vector autoregressive models
author: Kjartan Kloster Osmundsen
date: '2019-04-02'
slug: stan-code-for-markov-switching-vector-autoregressive-models
categories:
  - R
  - Stan
tags: []
image:
  caption: ''
  focal_point: ''
---



<p>This post regards my <a href="https://github.com/kjartako/MS_VAR">MS_VAR</a> Github repository, which contains code used in the following <a href="https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1565580">paper</a>:</p>
<p>Osmundsen, Kjartan Kloster, Tore Selland Kleppe, and Atle Oglend. “MCMC for Markov-switching models—Gibbs sampling vs. marginalized likelihood.” Communications in Statistics-Simulation and Computation (2019): 1-22.</p>
<div id="the-model" class="section level1">
<h1>The model</h1>
<p>A Markov-switching vector autoregressive (MS-VAR) model is an autoregressive mixture model governed by a (hidden) finite state Markov chain. In the mentioned paper, the MS-VAR model is expressed as:</p>
<span class="math display" id="eq:Y">\[\begin{equation}
\boldsymbol{Y}_{t} =\left[\sum_{i=1}^p {\boldsymbol{\phi}_i}_{(S_{t})}\boldsymbol{Y}_{t-i} \right]+\boldsymbol{\mu}_{(S_{t})}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{d},
\tag{1}
\end{equation}\]</span>
<p>where <span class="math inline">\(\boldsymbol{Y}_{t}\)</span> are <span class="math inline">\(d\)</span>-dimensional observations, <span class="math inline">\(n\)</span> is the number of such observations, <span class="math inline">\(p\)</span> is the number of autoregressive lags, <span class="math inline">\(m\)</span> is the number of states,<span class="math inline">\({\boldsymbol{\phi}_i}_{(S)},i\in(1,2,\dots,p),S\in(1,2,\dots,m)\)</span> are the autoregressive coefficient matrices, and <span class="math inline">\(\boldsymbol{\mu}_{(S)},S\in(1,2,\dots,m)\)</span> are the mean vectors.</p>
<p><span class="math inline">\(S_{t}\in(1,2,\dots,m),t\in(p+1,p+2,\dots,n)\)</span> are the latent state variables, which follow a first-order time homogeneous Markov Chain characterized by an <span class="math inline">\(m \times m\)</span> transition probability matrix:</p>
<p><span class="math display">\[
\boldsymbol{Q}=\begin{bmatrix}p_{11} &amp; \dots &amp; p_{1m}\\
\vdots &amp; \vdots &amp; \vdots\\
p_{m1} &amp; \dots &amp; p_{mm}
\end{bmatrix},\qquad p_{ij}=p(S_{t}=j|S_{t-1}=i).
\]</span></p>
</div>
<div id="numerical-examples" class="section level1">
<h1>Numerical examples</h1>
<p>The code fits the MS-VAR model to data input, where the user specifies number of regimes (<span class="math inline">\(m\)</span>) and number of autoregressive terms (<span class="math inline">\(p\)</span>). The user also determines whether the latent states applies to the mean structure and/or the covariance structure.</p>
<p>The estimation procedure is implemented in <a href="https://mc-stan.org/">Stan</a>, which is accessed through its <a href="https://www.r-project.org/">R</a> interface: <a href="https://mc-stan.org/users/interfaces/rstan">rstan</a>.</p>
<p>The repository includes example files for two of the possible MS-VAR specifications that can be estimated using this Stan code:</p>
<div id="ms_var_example_sim.r" class="section level2">
<h2>MS_VAR_example_sim.R</h2>
<p>The <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/MS_VAR_example_sim.R">first example file</a> fits an unrestricted two-dimensional, two-state case of <a href="#eq:Y">(1)</a>, with one autoregressive lag:</p>
<span class="math display">\[\begin{equation}
\boldsymbol{Y}_{t} ={\boldsymbol{\phi}_1}_{(S_{t})}\boldsymbol{Y}_{t-1} +\boldsymbol{\mu}_{(S_{t})}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{2}.
\end{equation}\]</span>
<p>The data input is a simulated <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/Y_750.txt">data set</a>, generated by the file <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/Data_generator.R">Data_generator.R</a> in the repository.</p>
<p><img src="/post/2019-04-02-stan-code-for-markov-switching-vector-autoregressive-models_files/figure-html/sim-1.png" width="672" /></p>
</div>
<div id="ms_var_example_usmacro.r" class="section level2">
<h2>MS_VAR_example_USmacro.R</h2>
The <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/MS_VAR_example_USmacro.R">second example file</a> fits a three-dimensional, two-state case of <a href="#eq:Y">(1)</a>, with four autoregressive lags, where the Markov-switching is restricted to the covariance structure:
<span class="math display">\[\begin{equation}
\boldsymbol{Y}_{t} =\boldsymbol{\phi}_{1}\boldsymbol{Y}_{t-1}+\boldsymbol{\phi}_{2}\boldsymbol{Y}_{t-2}+\boldsymbol{\phi}_{3}\boldsymbol{Y}_{t-3}+\boldsymbol{\phi}_{4}\boldsymbol{Y}_{t-4}+\boldsymbol{\mu}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{3}.
\end{equation}\]</span>
<p>Following Lanne et al.(2010), the data input is a quarterly US macro data set, consisting of inflation, unemployment and an interest rate (3-Month Treasury Bill), ranging from January 1960 to January 2018. This <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/USmacro.txt">data set</a> is available in the repository.</p>
<p><img src="/post/2019-04-02-stan-code-for-markov-switching-vector-autoregressive-models_files/figure-html/USmacro-1.png" width="672" /></p>
</div>
</div>
<div id="running-the-code" class="section level1">
<h1>Running the code</h1>
<p>To be able to run the code, you should install <a href="https://cloud.r-project.org/">R</a> and <a href="https://www.rstudio.com/products/rstudio/download/">Rstudio</a>. After opening Rstudio, you need to install the following packages: rstan, coda and rstudioapi.</p>
<p>Then download the complete <a href="https://github.com/kjartako/MS_VAR">repository</a>, keeping the original file structure. You should now be able to run one of the example files.</p>
<p>Below is some of the resulting output from the first example file, using 4 chains:</p>
<pre class="r"><code>options(scipen=999) # avoid scientific notation
summary(pars_ls$pars)$statistics[1:pars_ls$index[1],]</code></pre>
<pre><code>##                       Mean          SD      Naive SE Time-series SE
## Q[1,1]        0.9691076593 0.010064709 0.00015913702  0.00013661482
## Q[2,2]        0.8767816057 0.039793706 0.00062919373  0.00052852579
## Q[1,2]        0.0308923407 0.010064709 0.00015913702  0.00013661482
## Q[2,1]        0.1232183943 0.039793706 0.00062919373  0.00052852579
## mu[1,1]       0.0060437427 0.007334371 0.00011596659  0.00008352485
## mu[2,1]       0.0303560824 0.025061662 0.00039625968  0.00028620366
## mu[1,2]       0.0009007403 0.007262776 0.00011483457  0.00008189346
## mu[2,2]       0.0172397612 0.027091917 0.00042836083  0.00032953087
## phi[1,1,1]    0.5874560258 0.031881257 0.00050408694  0.00050392536
## phi[2,1,1]    0.9276820980 0.046285310 0.00073183501  0.00068726288
## phi[1,2,1]   -0.0678393937 0.031799041 0.00050278699  0.00050745179
## phi[2,2,1]    0.0852113837 0.045305205 0.00071633819  0.00069887113
## phi[1,1,2]    0.3052529153 0.023702753 0.00037477344  0.00038034655
## phi[2,1,2]    0.0391969647 0.040803556 0.00064516087  0.00061162543
## phi[1,2,2]    1.0418985187 0.024391420 0.00038566221  0.00039295457
## phi[2,2,2]    0.9016403627 0.042870930 0.00067784892  0.00064427269
## sigma[1,1,1]  0.0248701678 0.001670158 0.00002640752  0.00002048969
## sigma[2,1,1]  0.0718282467 0.010037321 0.00015870397  0.00013299935
## sigma[1,2,1]  0.0061532123 0.001136347 0.00001796723  0.00001404714
## sigma[2,2,1]  0.0015150417 0.006767256 0.00010699972  0.00008347834
## sigma[1,1,2]  0.0061532123 0.001136347 0.00001796723  0.00001404714
## sigma[2,1,2]  0.0015150417 0.006767256 0.00010699972  0.00008347834
## sigma[1,2,2]  0.0250218394 0.001632539 0.00002581270  0.00001916521
## sigma[2,2,2]  0.0696324964 0.009839120 0.00015557015  0.00012895136</code></pre>
<pre class="r"><code>plot(pars_ls$pars[,c(1,pars_ls$index[2])])</code></pre>
<p><img src="/post/2019-04-02-stan-code-for-markov-switching-vector-autoregressive-models_files/figure-html/res-1.png" width="768" /></p>
<p>As the first example file uses simulated data, we can compare the estimated state values to the actual <a href="https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/S_750.txt">states</a>:</p>
<pre class="r"><code>states=as.matrix(pars_ls$pars)[,(pars_ls$index[1]+1):pars_ls$index[3]]
plot(colMeans(states),ylab=&quot;Mean state&quot;)
points(S+1.01,col=&#39;red&#39;)</code></pre>
<p><img src="/post/2019-04-02-stan-code-for-markov-switching-vector-autoregressive-models_files/figure-html/res2-1.png" width="768" /></p>
<p>For details on parameter priors, model specification and label-switching, see the <a href="https://github.com/kjartako/MS_VAR/wiki">repository wiki</a>.</p>
</div>
