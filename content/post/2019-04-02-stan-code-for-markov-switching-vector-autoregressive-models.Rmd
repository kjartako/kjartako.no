---
title: Stan-code for Markov-switching vector autoregressive models
author: Kjartan Kloster Osmundsen
date: '2019-04-02'
slug: stan-code-for-markov-switching-vector-autoregressive-models
categories:
  - R
  - Stan
tags: []
image:
  caption: ''
  focal_point: ''
---

This post regards my [MS_VAR](https://github.com/kjartako/MS_VAR) Github repository, which contains code used in the following [paper](https://www.tandfonline.com/doi/full/10.1080/03610918.2019.1565580):

Osmundsen, Kjartan Kloster, Tore Selland Kleppe, and Atle Oglend. "MCMC for Markov-switching modelsâ€”Gibbs sampling vs. marginalized likelihood." Communications in Statistics-Simulation and Computation (2019): 1-22.

# The model

A Markov-switching vector autoregressive (MS-VAR) model is an autoregressive mixture model governed by a (hidden) finite state Markov chain. In the mentioned paper, the MS-VAR model is expressed as:

\begin{equation}
\boldsymbol{Y}_{t} =\left[\sum_{i=1}^p {\boldsymbol{\phi}_i}_{(S_{t})}\boldsymbol{Y}_{t-i} \right]+\boldsymbol{\mu}_{(S_{t})}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{d},
(\#eq:Y)
\end{equation}
where $\boldsymbol{Y}_{t}$ are $d$-dimensional observations, $n$ is the number of such observations, $p$ is the number of autoregressive lags, $m$ is the number of states,${\boldsymbol{\phi}_i}_{(S)},i\in(1,2,\dots,p),S\in(1,2,\dots,m)$ are the autoregressive
coefficient matrices, and $\boldsymbol{\mu}_{(S)},S\in(1,2,\dots,m)$
are the mean vectors.

$S_{t}\in(1,2,\dots,m),t\in(p+1,p+2,\dots,n)$ are
the latent state variables, which follow a first-order time homogeneous
Markov Chain characterized by an $m \times m$ transition probability matrix: 

\[
\boldsymbol{Q}=\begin{bmatrix}p_{11} & \dots & p_{1m}\\
\vdots & \vdots & \vdots\\
p_{m1} & \dots & p_{mm}
\end{bmatrix},\qquad p_{ij}=p(S_{t}=j|S_{t-1}=i).
\]

# Numerical examples

The code fits the MS-VAR model to data input, where the user specifies number of regimes ($m$) and number of autoregressive terms ($p$). The user also determines whether the latent states applies to the mean structure and/or the covariance structure.

The estimation procedure is implemented in [Stan](https://mc-stan.org/), which is accessed through its [R](https://www.r-project.org/) interface: [rstan](https://mc-stan.org/users/interfaces/rstan).

The repository includes example files for two of the possible MS-VAR specifications that can be estimated using this Stan code:  

## MS_VAR_example_sim.R
The [first example file](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/MS_VAR_example_sim.R) fits an unrestricted two-dimensional, two-state case of \@ref(eq:Y), with one autoregressive lag:

\begin{equation}
\boldsymbol{Y}_{t} ={\boldsymbol{\phi}_1}_{(S_{t})}\boldsymbol{Y}_{t-1} +\boldsymbol{\mu}_{(S_{t})}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{2}.
\end{equation}

The data input is a simulated [data set](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/Y_750.txt), generated by the file [Data_generator.R](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/Data_generator.R) in the repository.

```{r libs,include=FALSE}
library(ggplot2)
library(MASS)
library(rstan)
library(coda)
pars_ls=readRDS(file="sim_pars_ls.rds")
```

```{r sim,echo=FALSE}
# Simulate data
mu = c(0,0);mu2 = c(0.01,0);rho = 0.2;rho2 = 0.2;sd=c(0.15,0.15);sd2=c(0.3,0.25)
sigma = matrix(c(sd[1]^2,rep(rho*sd[1]*sd[2],2),sd[2]^2),nrow=2,byrow=TRUE)
sigma2 = matrix(c(sd2[1]^2,rep(rho2*sd2[1]*sd2[2],2),sd2[2]^2),nrow=2,byrow=TRUE)
phi = matrix(c(0.6,0.3,0.01,0.98),nrow=2,byrow=TRUE)
phi2 = matrix(c(0.98,0.01,0.01,0.99),nrow=2,byrow=TRUE)
Q = matrix(c(0.97,0.03,0.1,0.9),nrow=2,byrow=TRUE)
delta = solve(t(diag(2)-Q +1),rep(1,2))

n=750
S = numeric(n)
Y = matrix(rep(NA,2*n),nrow=n,byrow=TRUE)

set.seed(123)
S[1] = sample(c(0,1),size=1,prob=delta)
Y[1,] = mvrnorm(n=1,mu=(1-S[1])*mu+S[1]*mu2,Sigma=(1-S[1])*sigma+S[1]*sigma2)

for (i in 2:n)
{
  S[i]=sample(c(0,1),size=1,prob=Q[S[i-1]+1,])
  Y[i,] =mvrnorm(n=1,mu=(1-S[i])*(mu+phi%*%Y[i-1,])+S[i]*(mu2+phi2%*%Y[i-1,]),Sigma=(sigma*(1-S[i])+sigma2*S[i]))
}
########

plot_data = data.frame(rep(c(1:n),2),c(Y[,1],Y[,2]),c(rep("Y[,1]",n),rep("Y[,2]",n)))
colnames(plot_data) = c("Observation","Change","Type")
plot_data$Type = factor(plot_data$Type,levels=c("Y[,1]","Y[,2]"))

Y_plot=ggplot(plot_data, aes(x = Observation,y=Change, group=Type)) +geom_line(size=1)+
  scale_colour_brewer(palette="Dark2")+ggtitle("Simulated data")+ylab("")+
  scale_y_continuous(breaks=c(-2,0,2),limits=c(-3,3.6))+
  facet_wrap(~Type, ncol = 2,scales = "free_y")+
  theme(text = element_text(size=15))+theme_bw()

Y_plot
```


## MS_VAR_example_USmacro.R
The [second example file](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/MS_VAR_example_USmacro.R) fits a three-dimensional, two-state case of \@ref(eq:Y), with four autoregressive lags, where the Markov-switching is restricted to the covariance structure: 
\begin{equation}
\boldsymbol{Y}_{t} =\boldsymbol{\phi}_{1}\boldsymbol{Y}_{t-1}+\boldsymbol{\phi}_{2}\boldsymbol{Y}_{t-2}+\boldsymbol{\phi}_{3}\boldsymbol{Y}_{t-3}+\boldsymbol{\phi}_{4}\boldsymbol{Y}_{t-4}+\boldsymbol{\mu}+\boldsymbol{\epsilon}_{t},\qquad\boldsymbol{\epsilon}_{t}\sim\mathcal{N}\left(\boldsymbol{0},\boldsymbol{\Sigma}_{(S_{t})}\right),\qquad\boldsymbol{Y}_{t}\in\mathbb{R}^{3}.
\end{equation}

Following Lanne et al.(2010), the data input is a quarterly US macro data set, consisting of inflation, unemployment and an interest
rate (3-Month Treasury Bill), ranging from January 1960 to January 2018. This [data set](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/USmacro.txt) is available in the repository.

```{r USmacro,echo=FALSE}
Y = unname(as.matrix(read.table(file='https://raw.githubusercontent.com/kjartako/MS_VAR/master/MS_VAR/Data/USmacro.txt',sep="\t")))
n=nrow(Y)

plot_data = data.frame(rep(c(1:n),3),c(Y[,1],Y[,2],Y[,3]),c(rep("Interest rate",n),rep("Unemployment rate",n),rep("Inflation rate",n)))
colnames(plot_data) = c("Observation","Change","Type")
plot_data$Type = factor(plot_data$Type,levels=c("Interest rate","Unemployment rate","Inflation rate"))

Y_plot=ggplot(plot_data, aes(x = Observation,y=Change, group=Type)) +geom_line(size=1)+
  scale_colour_brewer(palette="Dark2")+ggtitle("Simulated data")+ylab("")+xlab("Year")+
  scale_x_continuous(breaks=c(1,41,82,123,164,205),labels= c("1960","1970","1980","1990","2000","2010"),expand=c(0.05, 0))+
  scale_y_continuous(breaks=c(0,5,10,15),limits=c(0,15))+
  facet_wrap(~Type, ncol = 3,scales = "free_y")+
  theme(text = element_text(size=15))+theme_bw()

Y_plot
```

# Running the code
To be able to run the code, you should install [R](https://cloud.r-project.org/) and [Rstudio](https://www.rstudio.com/products/rstudio/download/). After opening Rstudio, you need to install the following packages: rstan, coda and rstudioapi. 

Then download the complete [repository](https://github.com/kjartako/MS_VAR), keeping the original file structure.
You should now be able to run one of the example files.

Below is some of the resulting output from the first example file, using 4 chains:

```{r res,echo=TRUE,fig.width = 8, fig.height = 6}
options(scipen=999) # avoid scientific notation
summary(pars_ls$pars)$statistics[1:pars_ls$index[1],]

plot(pars_ls$pars[,c(1,pars_ls$index[2])])
```

As the first example file uses simulated data, we can compare the estimated state values (black) to the actual [states](https://github.com/kjartako/MS_VAR/blob/master/MS_VAR/Data/S_750.txt) (red):


```{r res2,echo=TRUE,fig.width = 8, fig.height = 6}
states=as.matrix(pars_ls$pars)[,(pars_ls$index[1]+1):pars_ls$index[3]]
plot(colMeans(states),ylab="Mean state",xlab="Observation")
points(S+1.01,col='red')
```


For details on parameter priors, model specification and label-switching, see the [repository wiki](https://github.com/kjartako/MS_VAR/wiki).
